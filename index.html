<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>نظام تسجيل الحضور والغياب</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Arabic:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Refactored CSS files -->
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="css/layout.css">
    <link rel="stylesheet" href="css/components.css">
    <link rel="stylesheet" href="css/modals.css">
    <link rel="stylesheet" href="css/responsive.css">

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
</head>
<body>
    <div class="app-container">
        <!-- Header -->
        <header class="header">
            <div class="header-content">
                <div class="logo">
                    <i class="fas fa-graduation-cap"></i>
                    <h1>تطبيق طلاب مستر محمود حمد</h1>
                    <span class="branding">برعاية المصمم أحمد محمد وهبة</span>
                </div>
                <div class="header-actions">
                    <div class="date-display" id="cairo-time-container">
                        <i class="fas fa-calendar-alt"></i>
                        <span id="cairo-date"></span>
                        <i class="fas fa-clock"></i>
                        <span id="cairo-time"></span>
                    </div>
                    <button class="theme-toggle" id="theme-toggle">
                        <i class="fas fa-moon"></i>
                    </button>
                </div>
            </div>
        </header>

        <!-- Navigation -->
        <nav class="nav-tabs">
            <button class="nav-tab active" data-tab="attendance">
                <i class="fas fa-check-circle"></i>
                تسجيل الحضور
            </button>
            <button class="nav-tab" data-tab="students">
                <i class="fas fa-users"></i>
                إدارة الطلاب
            </button>
            <button class="nav-tab" data-tab="reports">
                <i class="fas fa-chart-line"></i>
                التقارير
            </button>
            <button class="nav-tab" data-tab="admin">
                <i class="fas fa-cogs"></i>
                الإدارة
            </button>
        </nav>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Attendance Tab -->
            <div id="attendance-tab" class="tab-content active">
                <!-- Content will be generated by JS -->
            </div>

            <!-- Students Tab -->
            <div id="students-tab" class="tab-content">
                <!-- Content will be generated by JS -->
            </div>

            <!-- Reports Tab -->
            <div id="reports-tab" class="tab-content">
                <!-- Content will be generated by JS -->
            </div>

            <!-- Admin Tab -->
            <div id="admin-tab" class="tab-content">
                <!-- Content will be generated by JS -->
            </div>
        </main>
    </div>

    <!-- Modals Container -->
    <div id="modals-container">
        <!-- Modals will be loaded here -->
    </div>
    
    <!-- Templates for tabs and modals -->
    <template id="attendance-template">
        <div class="attendance-section">
            <div class="scan-area">
                <!-- سياق الحضور: اختيار الصف والمجموعة أولا -->
                <div class="report-filters" style="margin-bottom: .5rem;">
                    <div class="filter-group">
                        <label for="attendance-grade-filter">الصف</label>
                        <select id="attendance-grade-filter">
                            <option value="all">اختر الصف</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label for="attendance-group-filter">المجموعة</label>
                        <select id="attendance-group-filter">
                            <option value="all">اختر المجموعة</option>
                        </select>
                    </div>
                </div>

                <div class="scan-input">
                    <div class="input-wrapper">
                        <input type="text" id="student-code" placeholder="أدخل كود الطالب بعد اختيار الصف والمجموعة" autofocus>
                        <div id="student-name-preview" class="student-name-preview"></div>
                    </div>
                    <div class="scan-buttons">
                        <button class="scan-btn btn" id="scan-btn">
                            <i class="fas fa-qrcode"></i>
                            مسح QR
                        </button>
                        <button class="scan-btn btn btn-secondary" id="scan-palm-btn">
                            <i class="fas fa-sign-in-alt"></i>
                            مسح بصمة الكف
                        </button>
                    </div>
                </div>
                <div class="quick-stats">
                    <div class="stat-card present">
                        <i class="fas fa-check"></i>
                        <div>
                            <span class="stat-number" id="present-count">0</span>
                            <span class="stat-label">حاضر</span>
                        </div>
                    </div>
                    <div class="stat-card late">
                        <i class="fas fa-clock"></i>
                        <div>
                            <span class="stat-number" id="late-count">0</span>
                            <span class="stat-label">متأخر</span>
                        </div>
                    </div>
                    <div class="stat-card absent">
                        <i class="fas fa-times"></i>
                        <div>
                            <span class="stat-number" id="absent-count">0</span>
                            <span class="stat-label">غائب</span>
                        </div>
                    </div>
                    <div class="stat-card total">
                        <i class="fas fa-users"></i>
                        <div>
                            <span class="stat-number" id="total-students">0</span>
                            <span class="stat-label">إجمالي</span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="attendance-list">
                <div class="list-header">
                    <h3>سجل الحضور اليوم</h3>
                    <div class="list-actions">
                        <button class="btn btn-secondary" id="mark-all-absent">
                            <i class="fas fa-user-times"></i>
                            تسجيل الغياب التلقائي
                        </button>
                        <button class="btn btn-primary" id="export-daily">
                            <i class="fas fa-download"></i>
                            تصدير اليوم
                        </button>
                    </div>
                </div>
                <div class="attendance-records" id="attendance-records">
                    <!-- Attendance records will be populated here -->
                </div>
            </div>
        </div>
    </template>

    <template id="students-template">
        <div class="students-section">
            <div class="students-header">
                <h2>إدارة الطلاب</h2>
                <div class="students-actions">
                    <button class="btn btn-primary" id="add-student-btn">
                        <i class="fas fa-plus"></i>
                        إضافة طالب
                    </button>
                    <button class="btn btn-secondary" id="import-students-btn">
                        <i class="fas fa-upload"></i>
                        استيراد ملف
                    </button>
                    <button class="btn btn-success" id="manual-entry-btn">
                        <i class="fas fa-table"></i>
                        إدخال جدول
                    </button>
                </div>
            </div>

            <div class="students-filters">
                <div class="filter-group">
                    <select id="students-grade-filter">
                        <option value="all">كل الصفوف</option>
                    </select>
                </div>
                <div class="filter-group">
                    <select id="students-group-filter">
                        <option value="all">كل المجموعات</option>
                    </select>
                </div>
                <div class="filter-group">
                    <button class="btn btn-secondary" id="export-students-qr-btn">
                        <i class="fas fa-qrcode"></i>
                        تصدير كل أكواد QR
                    </button>
                </div>
            </div>

            <div class="search-bar">
                <input type="text" id="search-students" placeholder="البحث عن طالب...">
                <i class="fas fa-search"></i>
            </div>

            <div class="students-list" id="students-list">
                <!-- Students list will be populated here -->
            </div>
        </div>
    </template>
    
    <template id="reports-template">
        <div class="reports-section">
            <h2>التقارير والإحصائيات</h2>
            
            <div class="report-filters">
                <div class="filter-group">
                    <label>من تاريخ:</label>
                    <input type="date" id="date-from">
                </div>
                <div class="filter-group">
                    <label>إلى تاريخ:</label>
                    <input type="date" id="date-to">
                </div>
                <div class="filter-group">
                    <label for="report-grade-filter">تصفية حسب الصف:</label>
                    <select id="report-grade-filter">
                        <option value="all">كل الصفوف</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label for="report-group-filter">تصفية حسب المجموعة:</label>
                    <select id="report-group-filter">
                        <option value="all">كل المجموعات</option>
                    </select>
                </div>
                <button class="btn btn-primary" id="generate-report">
                    <i class="fas fa-chart-bar"></i>
                    إنشاء التقرير
                </button>
            </div>

            <div class="report-results" id="report-results">
                <!-- Detailed student reports will be shown here -->
            </div>
        </div>
    </template>

    <template id="admin-template">
        <div class="admin-section">
            <h2>لوحة تحكم الإدارة</h2>
            <div class="admin-actions">
                <div class="admin-action-card">
                    <i class="fas fa-cogs"></i>
                    <h3>الإعدادات العامة</h3>
                    <p>التحكم في الإعدادات الأساسية للنظام مثل وقت التأخير.</p>
                    <button class="btn btn-secondary" id="open-admin-settings-btn">فتح الإعدادات</button>
                </div>
                <div class="admin-action-card">
                    <i class="fas fa-door-closed"></i>
                    <h3>إنهاء اليوم الدراسي</h3>
                    <p>يقوم بحفظ جميع بيانات اليوم ومنع أي تعديلات عليه.</p>
                    <button class="btn btn-danger" id="end-day-btn">إنهاء اليوم</button>
                </div>
                <div class="admin-action-card">
                    <i class="fas fa-calendar-plus"></i>
                    <h3>بدء يوم جديد</h3>
                    <p>إغلاق اليوم الحالي وبدء يوم دراسي جديد لحفظ السجلات.</p>
                    <button class="btn btn-success" id="start-new-day-btn">بدء يوم جديد</button>
                </div>
                <div class="admin-action-card">
                    <i class="fas fa-history"></i>
                    <h3>سجل النشاطات</h3>
                    <p>عرض سجل بجميع الإجراءات الهامة التي تمت في النظام.</p>
                    <button class="btn btn-secondary" id="view-log-btn">عرض السجل</button>
                </div>
                <div class="admin-action-card">
                    <i class="fas fa-key"></i>
                    <h3>تغيير كلمة المرور</h3>
                    <p>تغيير كلمة مرور المدير.</p>
                    <button class="btn btn-secondary" id="change-password-btn">تغيير كلمة المرور</button>
                </div>
            </div>

            <div id="activity-log-container" class="activity-log-container" style="display: none;">
                <h3>سجل النشاطات</h3>
                <div class="log-actions">
                    <button class="btn btn-danger btn-small" id="clear-log-btn">مسح السجل</button>
                </div>
                <div id="activity-log-list" class="activity-log-list">
                    <!-- Activity log items will be populated here -->
                </div>
            </div>
        </div>
    </template>

    <template id="modals-template">
        <!-- Add Student Modal -->
        <div id="add-student-modal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3 id="student-modal-title">إضافة طالب جديد</h3>
                    <span class="close">&times;</span>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="editing-student-id">
                    <div class="form-group">
                        <label>اسم الطالب:</label>
                        <input type="text" id="new-student-name" placeholder="أدخل اسم الطالب">
                    </div>
                    <div class="form-group">
                        <label>كود الطالب:</label>
                        <input type="text" id="new-student-code" placeholder="أدخل كود الطالب">
                        <button class="btn btn-secondary" id="generate-code">
                            <i class="fas fa-random"></i>
                            إنشاء كود تلقائي
                        </button>
                    </div>
                    <div class="form-group">
                        <label>الصف:</label>
                        <input type="text" id="new-student-class" placeholder="مثال: الصف الأول الثانوي" list="class-options">
                    </div>
                    <div class="form-group">
                        <label>المجموعة:</label>
                        <input type="text" id="new-student-group" placeholder="مثال: مجموعة السبت صباحاً" list="group-options">
                    </div>

                    <!-- اقتراحات ديناميكية للقيم الموجودة -->
                    <datalist id="class-options"></datalist>
                    <datalist id="group-options"></datalist>

                    <div class="form-group">
                        <label>اسم ولي الأمر:</label>
                        <input type="text" id="new-student-guardian-name" placeholder="أدخل اسم ولي الأمر">
                    </div>
                    <div class="form-group">
                        <label>رقم هاتف ولي الأمر:</label>
                        <input type="tel" id="new-student-guardian-phone" placeholder="أدخل رقم الهاتف">
                    </div>
                    <div class="form-group">
                        <label>حالة الطالب:</label>
                        <select id="new-student-status">
                            <option value="عام">عام</option>
                            <option value="خاص">خاص</option>
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" id="cancel-add">إلغاء</button>
                    <button class="btn btn-primary" id="confirm-add">حفظ</button>
                </div>
            </div>
        </div>

        <!-- QR Code Display Modal -->
        <div id="qr-code-modal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3 id="qr-modal-title">QR Code</h3>
                    <span class="close qr-close">&times;</span>
                </div>
                <div class="modal-body qr-modal-body">
                    <canvas id="qr-code-canvas"></canvas>
                    <div id="qr-student-name" class="qr-student-name"></div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary qr-close">إغلاق</button>
                    <button class="btn btn-primary" id="download-qr-btn">
                        <i class="fas fa-download"></i>
                        تحميل
                    </button>
                </div>
            </div>
        </div>

        <!-- QR Scanner Modal -->
        <div id="qr-scanner-modal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3>مسح QR Code</h3>
                    <span class="close scanner-close">&times;</span>
                </div>
                <div class="modal-body">
                    <div id="qr-reader"></div>
                    <div id="qr-camera-warning" class="camera-warning" style="display: none;">
                        <h4><i class="fas fa-exclamation-triangle"></i> فشل في تشغيل الكاميرا</h4>
                        <p>
                            لا يمكن الوصول إلى الكاميرا. قد يكون ذلك لأحد الأسباب التالية:
                        </p>
                        <ul>
                            <li>التطبيق لا يعمل على رابط آمن (https).</li>
                            <li>لم يتم منح إذن استخدام الكاميرا للمتصفح أو للتطبيق.</li>
                            <li>الكاميرا مستخدمة بواسطة تطبيق آخر.</li>
                        </ul>
                        <p>
                            إذا كنت تستخدم نسخة تطبيق مثبتة (APK/APP)، فقد تحتاج إلى نسخة تم بناؤها باستخدام أدوات تطلب إذن الكاميرا مباشرة من نظام التشغيل.
                        </p>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary scanner-close">إلغاء</button>
                </div>
            </div>
        </div>

        <!-- Manual Entry Modal -->
        <div id="manual-entry-modal" class="modal">
            <div class="modal-content modal-large">
                <div class="modal-header">
                    <h3>إدخال بيانات الطلاب يدوياً</h3>
                    <span class="close manual-close">&times;</span>
                </div>
                <div class="modal-body">
                    <div class="manual-entry-info">
                        <p>أدخل بيانات الطلاب في الجدول أدناه. يمكنك نسخ البيانات من Excel أو أي جدول آخر ولصقها هنا.</p>
                    </div>
                    
                    <div class="bulk-input-section">
                        <h4>أو الصق قائمة الطلاب هنا:</h4>
                        <textarea id="bulk-student-input" placeholder="الصق بيانات الطلاب هنا، كل طالب في سطر.
مثال 1: ٢ بدرهانی سمیر
مثال 2: احمد محمد وهبه 61 السبت والثلاثاء الصف الثالث الثانوي رقم ولي الامر 0101358965
سيتم تحليل البيانات تلقائياً ومحاولة ملء الحقول."></textarea>
                        <div class="bulk-input-actions">
                            <button class="btn btn-primary" id="parse-bulk-input">
                                <i class="fas fa-magic"></i>
                                تحليل وإضافة للجدول
                            </button>
                            <button class="btn btn-secondary" id="clear-bulk-input">
                                <i class="fas fa-eraser"></i>
                                مسح النص
                            </button>
                        </div>
                    </div>
                    
                    <div class="table-controls">
                        <button class="btn btn-secondary btn-small" id="add-row">
                            <i class="fas fa-plus"></i>
                            إضافة صف
                        </button>
                        <button class="btn btn-danger btn-small" id="clear-table">
                            <i class="fas fa-trash"></i>
                            مسح الجدول
                        </button>
                        <button class="btn btn-success btn-small" id="auto-generate-codes">
                            <i class="fas fa-magic"></i>
                            إنشاء أكواد تلقائي
                        </button>
                    </div>

                    <div class="manual-entry-table">
                        <table id="students-entry-table">
                            <thead>
                                <tr>
                                    <th>اسم الطالب</th>
                                    <th>كود الطالب</th>
                                    <th>الصف</th>
                                    <th>المجموعة</th>
                                    <th>ولي الأمر</th>
                                    <th>هاتف ولي الأمر</th>
                                    <th>الحالة</th>
                                    <th>حذف</th>
                                </tr>
                            </thead>
                            <tbody id="entry-table-body">
                                <!-- Rows will be added dynamically -->
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" id="cancel-manual-entry">إلغاء</button>
                    <button class="btn btn-primary" id="save-manual-entries">
                        <i class="fas fa-save"></i>
                        حفظ البيانات
                    </button>
                </div>
            </div>
        </div>

        <!-- Absent Student Alert Modal -->
        <div id="absent-alert-modal" class="modal">
            <div class="modal-content">
                <div class="modal-header modal-header-danger">
                    <h3 id="absent-alert-title"><i class="fas fa-exclamation-triangle"></i> تنبيه غياب</h3>
                </div>
                <div class="modal-body">
                    <p id="absent-alert-message" style="font-size: 1.2rem; text-align: center; line-height: 1.8;"></p>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" id="absent-alert-cancel">تراجع</button>
                    <button class="btn btn-primary" id="absent-alert-confirm">تسجيل حضور</button>
                </div>
            </div>
        </div>

        <!-- Confirm Mark All Absent Modal -->
        <div id="confirm-absent-modal" class="modal">
            <div class="modal-content">
                <div class="modal-header modal-header-danger">
                    <h3><i class="fas fa-user-times"></i> تأكيد تسجيل الغياب</h3>
                    <span class="close confirm-absent-close">&times;</span>
                </div>
                <div class="modal-body">
                    <p id="confirm-absent-message" style="font-size: 1.1rem; line-height: 1.8; text-align: center;"></p>
                    <div class="camera-warning" style="margin-top: 1rem;">
                        <p style="margin: 0;">
                            سيتم تطبيق الغياب على الطلاب المحددين وقت الضغط على الزر فقط حتى إذا قمت بتغيير الصف أو المجموعة قبل التأكيد.
                        </p>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary confirm-absent-close">إلغاء</button>
                    <button class="btn btn-danger" id="confirm-absent-apply">
                        <i class="fas fa-user-times"></i> تأكيد الغياب
                    </button>
                </div>
            </div>
        </div>

        <!-- Password Modal -->
        <div id="password-modal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3 id="password-modal-title">مطلوب كلمة المرور</h3>
                    <span class="close password-close">&times;</span>
                </div>
                <div class="modal-body">
                    <p id="password-prompt-message">يرجى إدخال كلمة مرور المدير للمتابعة.</p>
                    <div class="form-group">
                        <label>كلمة المرور:</label>
                        <input type="password" id="admin-password-input" placeholder="أدخل كلمة المرور">
                    </div>
                    <div class="form-group" id="new-password-group" style="display: none;">
                        <label>كلمة المرور الجديدة:</label>
                        <input type="password" id="admin-new-password-input" placeholder="أدخل كلمة المرور الجديدة">
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary password-close">إلغاء</button>
                    <button class="btn btn-primary" id="confirm-password-btn">تأكيد</button>
                </div>
            </div>
        </div>

        <!-- Student Profile Modal -->
        <div id="student-profile-modal" class="modal">
            <div class="modal-content modal-large">
                <div class="modal-header">
                    <h3 id="profile-modal-title">بروفايل الطالب</h3>
                    <span class="close profile-close">&times;</span>
                </div>
                <div class="modal-body">
                    <div id="profile-details-content">
                        <!-- Student details will be populated here -->
                    </div>
                    <div class="grades-section">
                        <div class="grades-header">
                            <h4>سجل الدرجات</h4>
                            <button class="btn btn-primary" id="add-grade-btn">
                                <i class="fas fa-plus"></i>
                                إضافة درجة
                            </button>
                        </div>
                        <div class="grades-summary">
                            <div class="grade-stats">
                                <div class="stat-item">
                                    <span class="stat-value" id="average-grade">--</span>
                                    <span class="stat-label">المتوسط العام</span>
                                </div>
                                <div class="stat-item">
                                    <span class="stat-value" id="highest-grade">--</span>
                                    <span class="stat-label">أعلى درجة</span>
                                </div>
                                <div class="stat-item">
                                    <span class="stat-value" id="lowest-grade">--</span>
                                    <span class="stat-label">أقل درجة</span>
                                </div>
                            </div>
                        </div>
                        <div class="grades-table-container">
                            <table id="grades-table">
                                <thead>
                                    <tr>
                                        <th>التاريخ</th>
                                        <th>عنوان الحصة</th>
                                        <th>الدرجة</th>
                                        <th>ملاحظات</th>
                                        <th>إجراء</th>
                                    </tr>
                                </thead>
                                <tbody id="grades-table-body">
                                    <!-- Grades will be populated here -->
                                </tbody>
                            </table>
                        </div>
                        
                        <div class="attendance-history-section">
                            <h4>سجل الحضور والغياب</h4>
                            <div class="attendance-summary">
                                <div class="summary-stats">
                                    <div class="stat-item">
                                        <span class="stat-value" id="total-attendance">0</span>
                                        <span class="stat-label">إجمالي الحضور</span>
                                    </div>
                                    <div class="stat-item">
                                        <span class="stat-value" id="total-absence">0</span>
                                        <span class="stat-label">إجمالي الغياب</span>
                                    </div>
                                    <div class="stat-item">
                                        <span class="stat-value" id="attendance-percentage">0%</span>
                                        <span class="stat-label">نسبة الحضور</span>
                                    </div>
                                </div>
                            </div>
                            <div class="attendance-history-table-container">
                                <table id="attendance-history-table">
                                    <thead>
                                        <tr>
                                            <th>التاريخ</th>
                                            <th>اليوم</th>
                                            <th>الحالة</th>
                                            <th>الوقت</th>
                                            <th>إجراء</th>
                                        </tr>
                                    </thead>
                                    <tbody id="attendance-history-body">
                                        <!-- Attendance history will be populated here -->
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <div class="behavioral-notes-section">
                            <h4>الملاحظات السلوكية والأكاديمية</h4>
                            <div class="add-note-form">
                                <div class="note-input-group">
                                    <textarea id="new-behavioral-note" placeholder="أدخل ملاحظة جديدة..."></textarea>
                                    <button class="btn btn-primary" id="add-behavioral-note">
                                        <i class="fas fa-plus"></i>
                                        إضافة
                                    </button>
                                </div>
                            </div>
                            <div class="behavioral-notes-list" id="behavioral-notes-list">
                                <!-- Behavioral notes will be populated here -->
                            </div>
                        </div>

                        <div class="biometric-section">
                            <h4>إدارة بصمة الكف</h4>
                            <div id="palm-print-status" class="palm-print-status">
                                <!-- Status will be populated here -->
                            </div>
                        </div>

                        <div class="monthly-report-section">
                            <h4>التقارير الشهرية</h4>
                            <div class="report-controls">
                                <div class="month-selector">
                                    <select id="report-month-selector">
                                        <!-- Month options will be populated here -->
                                    </select>
                                </div>
                                <div class="report-actions">
                                    <button class="btn btn-primary" id="generate-monthly-report">
                                        <i class="fas fa-chart-bar"></i>
                                        إنشاء التقرير
                                    </button>
                                    <button class="btn btn-success" id="export-monthly-report" style="display: none;">
                                        <i class="fas fa-download"></i>
                                        تصدير PDF
                                    </button>
                                </div>
                            </div>
                            <div id="monthly-report-content">
                                <!-- Monthly report content will be displayed here -->
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary profile-close">إغلاق</button>
                </div>
            </div>
        </div>

        <!-- Add Grade Modal -->
        <div id="add-grade-modal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3>إضافة درجة جديدة</h3>
                    <span class="close grade-close">&times;</span>
                </div>
                <div class="modal-body">
                    <div class="form-group">
                        <label>التاريخ:</label>
                        <input type="date" id="grade-date">
                    </div>
                    <div class="form-group">
                        <label>عنوان الحصة:</label>
                        <input type="text" id="session-title" placeholder="مثال: امتحان قصير - الوحدة الأولى">
                    </div>
                    <div class="form-group">
                        <label>الدرجة:</label>
                        <input type="text" id="grade-value" placeholder="مثال: 8/10 أو 85%">
                    </div>
                    <div class="form-group">
                        <label>ملاحظات:</label>
                        <textarea id="grade-notes" placeholder="ملاحظات إضافية..."></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary grade-close">إلغاء</button>
                    <button class="btn btn-primary" id="save-grade">حفظ</button>
                </div>
            </div>
        </div>

        <!-- Palm Enrollment Modal -->
        <div id="palm-enroll-modal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3 id="palm-enroll-title">تسجيل بصمة الكف</h3>
                    <span class="close palm-enroll-close">&times;</span>
                </div>
                <div class="modal-body palm-enroll-body">
                    <p id="palm-enroll-instructions">يرجى وضع كف الطالب أمام الكاميرا لبدء المسح.</p>
                    <div class="scanner-container">
                        <video id="palm-video-feed" playsinline autoplay muted></video>
                        <div id="palm-camera-warning" class="camera-warning" style="display: none;">
                            <h4><i class="fas fa-exclamation-triangle"></i> فشل في تشغيل الكاميرا</h4>
                            <p>
                                لا يمكن الوصول للكاميرا. للتحقق من بصمة الكف، يجب أن يعمل التطبيق على رابط آمن (https) مع منح إذن الوصول للكاميرا.
                            </p>
                        </div>
                        <div class="scanner-overlay">
                            <div class="scanner-light"></div>
                            <div class="scanner-grid"></div>
                            <div class="scanner-corners">
                                <div class="corner top-left"></div>
                                <div class="corner top-right"></div>
                                <div class="corner bottom-left"></div>
                                <div class="corner bottom-right"></div>
                            </div>
                            <div id="thermal-overlay" class="thermal-overlay"></div>
                        </div>
                    </div>
                    <div id="palm-enroll-progress-container" class="progress-bar-container">
                        <div id="enroll-progress-bar" class="progress-bar"></div>
                    </div>
                    <p id="enroll-progress-text" class="progress-text"></p>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" id="palm-retry-btn" style="display: none;">
                        <i class="fas fa-redo"></i>
                        حاول مرة أخرى
                    </button>
                    <button class="btn btn-secondary palm-enroll-close">إلغاء</button>
                </div>
            </div>
        </div>

        <!-- Admin Settings Modal -->
        <div id="admin-modal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3>إعدادات الإدارة</h3>
                    <span class="close admin-close">&times;</span>
                </div>
                <div class="modal-body">
                    <div class="form-group">
                        <label>وقت احتساب التأخير (بعد هذا الوقت يعتبر الطالب متأخراً)</label>
                        <input type="time" id="late-time" value="08:00">
                    </div>
                    <div class="form-group">
                        <label>اسم المؤسسة (للطباعة في التقارير)</label>
                        <input type="text" id="institution-name" placeholder="مثال: دروس مستر محمود حمد">
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary admin-close">إلغاء</button>
                    <button class="btn btn-primary" id="save-admin-settings">حفظ</button>
                </div>
            </div>
        </div>
        
        <!-- Success/Error Messages -->
        <div id="notification" class="notification">
            <div class="notification-content">
                <i class="notification-icon"></i>
                <span class="notification-message"></span>
            </div>
        </div>
    </template>

    <script type="importmap">
    {
        "imports": {
            "chart.js": "https://esm.sh/chart.js@4.4.0",
            "qrcode": "https://esm.sh/qrcode@1.5.3",
            "html5-qrcode": "https://esm.sh/html5-qrcode@2.3.8"
        }
    }
    </script>
    <script src="app.js" type="module"></script>
</body>
</html>